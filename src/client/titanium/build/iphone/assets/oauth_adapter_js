Ti.include(path_lib+"sha1.js"),Ti.include(path_lib+"oauth.js");var OAuthAdapter=function(e,t,n,r){var i=e,s=t,o=n,u=null,a=null,f=null,l=null,c=null,h={consumerSecret:i,tokenSecret:""},p=!0,d=[];r&&r.useQueue==0&&(p=!1);var v=null,m=null,g=null,y=null;this.loadAccessToken=function(e){Ti.API.debug("Loading access token for service ["+e+"].");var t=Ti.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory,e+".config");if(t.exists()==0)return;var n=t.read();if(n==null)return;var r;try{r=JSON.parse(n.text)}catch(i){return}if(!r)return;r.accessToken&&(l=r.accessToken),r.accessTokenSecret&&(c=r.accessTokenSecret),Ti.API.debug("Loading access token: done [accessToken:"+l+"][accessTokenSecret:"+c+"].")},this.saveAccessToken=function(e){Ti.API.debug("Saving access token ["+e+"].");var t=Ti.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory,e+".config");t==null&&(t=Ti.Filesystem.createFile(Ti.Filesystem.applicationDataDirectory,e+".config")),t.write(JSON.stringify({accessToken:l,accessTokenSecret:c})),Ti.API.debug("Saving access token: done.")},this.clearAccessToken=function(e){var t=Ti.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory,e+".config");t==null&&(t=Ti.Filesystem.createFile(Ti.Filesystem.applicationDataDirectory,e+".config")),t.write(JSON.stringify({accessToken:null,accessTokenSecret:null})),l=null,c=null},this.clearActionsQueue=function(){while((q=d.shift())!=null){var e=q.parameters||[];e.onError&&e.onError({error:"clearActionsQueue() was called"})}},this.isAuthorized=function(){return l!=null&&c!=null};var b=function(e,t){var n={action:e,method:t?t:"POST",parameters:[]};return n.parameters.push(["oauth_consumer_key",s]),n.parameters.push(["oauth_signature_method",o]),n};this.getPin=function(){return u},this.getRequestToken=function(e,t){h.tokenSecret="";var n=b(e);OAuth.setTimestampAndNonce(n),OAuth.SignatureMethod.sign(n,h);var r=Ti.Network.createHTTPClient();r.onload=function(){var e=OAuth.getParameterMap(r.responseText);a=e.oauth_token,f=e.oauth_token_secret,Ti.API.debug("request token got the following response: "+r.responseText),t(r.responseText)},r.onerror=function(e){Ti.API.debug(e),Ti.API.debug({error:"["+r.status+"] "+r.responseText}),t(null)},r.open("POST",e,!0),r.send(OAuth.getParameterMap(n.parameters))};var w=function(){Ti.API.debug("destroyAuthorizeUI");if(!v)return;try{g.removeEventListener("load",E),v.hide(),v.close(),v.remove(m),m.remove(g),g=null,m=null,v=null}catch(e){Ti.API.debug("Cannot destroy the authorize UI. Ignoring.")}},E=function(e){Ti.API.debug("authorizeUILoaded");var t=g.evalJS("window.document.querySelector('kbd[aria-labelledby=\"code-desc\"] > code').innerHTML");t&&(u=t,y&&y())};this.showAuthorizeUI=function(e,t){y=t,v=Ti.UI.createWindow({modal:!0,fullscreen:!0});var n=Ti.UI.create2DMatrix().scale(0);m=Ti.UI.createView({top:5,width:"99%",height:"600",border:5,backgroundColor:"white",borderColor:"#aaa",borderRadius:20,borderWidth:5,zIndex:-1,transform:n}),closeLabel=Ti.UI.createLabel({textAlign:"right",font:{fontWeight:"bold",fontSize:"12pt"},text:"(X)",top:10,right:12,height:14}),g=Ti.UI.createWebView({url:e,top:closeLabel.height+closeLabel.top,width:"97%",height:m.height-closeLabel.height-closeLabel.top-m.borderWidth*4,autoDetect:[Ti.UI.AUTODETECT_NONE]}),Ti.version<"1.7.0"&&(m.width=310,m.height=450,g.width=300,g.height=m.height-closeLabel.height-closeLabel.top-m.borderWidth*4),Ti.API.debug("Setting:["+Ti.UI.AUTODETECT_NONE+"]"),g.addEventListener("load",E),m.add(g),closeLabel.addEventListener("click",function(e){w()}),m.add(closeLabel),v.add(m),v.open();var r=Ti.UI.createAnimation();r.transform=Ti.UI.create2DMatrix(),r.duration=500,m.animate(r)},this.getAccessToken=function(e,t){h.tokenSecret=f;var n=b(e);n.parameters.push(["oauth_token",a]),n.parameters.push(["oauth_verifier",u]),OAuth.setTimestampAndNonce(n),OAuth.SignatureMethod.sign(n,h);var r=OAuth.getParameterMap(n.parameters);for(var i in r)Ti.API.debug(i+": "+r[i]);var s=Ti.Network.createHTTPClient();s.onload=function(){var e=OAuth.getParameterMap(s.responseText);l=e.oauth_token,c=e.oauth_token_secret;var n=e.user_id,r=e.screen_name;Ti.App.Properties.setString("user_id",n),Ti.App.Properties.setString("screen_name",r),Ti.API.info("------------------------ in getAccessToken"),Ti.API.info("get user_id from resonseParams*"+n),Ti.API.info("get screen_name from responseParams*"+r),Ti.API.debug("*** get access token, Response: "+s.responseText),S(),w(),t()},s.onerror=function(e){Ti.API.debug(e),w(),t()},s.open("POST",e,!0),s.send(r)};var S=function(){if(!p)return;Ti.API.debug("Processing queue.");while((q=d.shift())!=null)L(q);Ti.API.debug("Processing queue: done.")},x="OAuth realm,oauth_version,oauth_consumer_key,oauth_nonce,oauth_signature,oauth_signature_method,oauth_timestamp,oauth_token".split(","),T=function(e){var t="";for(var n=0,r=x.length;n<r;n++){var i=x[n];e[i]!=undefined&&(t+=i+'="'+encodeURIComponent(e[i])+'",')}return Ti.API.debug("authorization header string : "+t),t},N=function(e){var t=x.join(",")+",";for(var n in e)t.indexOf(n+",")>=0&&delete e[n]},C=function(e,t){var n=x.join(",")+",",r=[],i=[];for(var s=0,o=t.length;s<o;s++){var u=t[s];n.indexOf(u[0]+",")<0?r.push(encodeURIComponent(u[0])+"="+encodeURIComponent(u[1])):i.push[u]}return t=i,r.length?(r=r.join("&"),[e+(e.indexOf("?")>=0?"&":"?")+r,t]):[e,t]},k=function(e,t){var n=[],r=[];for(var i in t)n.push(encodeURIComponent(i)+"="+encodeURIComponent(t[i]));return n.sort(),n.length?(n=n.join("&"),e+(e.indexOf("?")>=0?"&":"?")+n):e},L=function(e){var t=e.url,n=e.parameters||[],r=e.title,i=e.method||"POST",s=e.resultByXML||!1;Ti.API.debug("Sending a message to the service at ["+t+"] with the following params: "+JSON.stringify(n));if(!this.isAuthorized()){if(!p)return;Ti.API.debug("The send status cannot be processed as the client doesn't have an access token. The status update will be sent as soon as the client has an access token."),d.push(e);return}h.tokenSecret=c;var o=b(t,i);o.parameters.push(["oauth_token",l]);for(a in n)o.parameters.push(n[a]);OAuth.setTimestampAndNonce(o),OAuth.SignatureMethod.sign(o,h);var u=OAuth.getParameterMap(o.parameters);for(var a in u)Ti.API.debug(a+": "+u[a]);i=="GET"&&(t=k(t,u),u=null,Ti.API.debug("url for GET:"+t));var f=Ti.Network.createHTTPClient();f.onload=function(){Ti.API.debug("*** sendStatus, Response: ["+f.status+"] "+f.responseText),(""+f.status).match(/^20[0-9]/)?e.onSuccess&&e.onSuccess(f.responseText):e.onError&&e.onError({error:"["+f.status+"] "+f.responseText})},f.onerror=function(t){Ti.API.debug(t),e.onError&&e.onError(t)},f.open(i,t,!0),f.send(u)};this.send=L}